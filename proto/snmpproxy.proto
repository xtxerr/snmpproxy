syntax = "proto3";

package snmpproxy.v1;

option go_package = "github.com/xtxerr/snmpproxy/internal/proto";

// ============================================================================
// Envelope - Wire format wrapper for all messages
// ============================================================================

message Envelope {
  uint64 id = 1;  // Request/Response correlation. Push messages use id=0.
  
  oneof payload {
    // Auth
    AuthRequest auth_req = 10;
    AuthResponse auth_resp = 11;
    
    // Browse (unified ls command)
    BrowseRequest browse_req = 20;
    BrowseResponse browse_resp = 21;
    
    // Target CRUD
    CreateTargetRequest create_target_req = 30;
    CreateTargetResponse create_target_resp = 31;
    UpdateTargetRequest update_target_req = 32;
    UpdateTargetResponse update_target_resp = 33;
    DeleteTargetRequest delete_target_req = 34;
    DeleteTargetResponse delete_target_resp = 35;
    
    // History
    GetHistoryRequest get_history_req = 40;
    GetHistoryResponse get_history_resp = 41;
    
    // Subscriptions
    SubscribeRequest subscribe_req = 50;
    SubscribeResponse subscribe_resp = 51;
    UnsubscribeRequest unsubscribe_req = 52;
    UnsubscribeResponse unsubscribe_resp = 53;
    
    // Config
    GetConfigRequest get_config_req = 60;
    GetConfigResponse get_config_resp = 61;
    SetConfigRequest set_config_req = 62;
    SetConfigResponse set_config_resp = 63;
    
    // Push (id=0)
    Sample sample = 80;
    
    // Error
    Error error = 99;
  }
}

// ============================================================================
// Common Types
// ============================================================================

message Error {
  int32 code = 1;
  string message = 2;
}

message Sample {
  string target_id = 1;
  int64 timestamp_ms = 2;
  uint64 counter = 3;
  string text = 4;
  bool valid = 5;
  string error = 6;
  int32 poll_ms = 7;
}

// ============================================================================
// Auth
// ============================================================================

message AuthRequest {
  string token = 1;
}

message AuthResponse {
  bool ok = 1;
  string session_id = 2;
  string message = 3;
}

// ============================================================================
// Browse (unified ls command)
// ============================================================================

message BrowseRequest {
  string path = 1;          // "", "targets", "targets/type/network", "server/status"
  bool recursive = 2;       // -r flag
  int32 depth = 3;          // -d flag, 0 = only direct children
  bool long_format = 4;     // -l flag, include full target details
}

message BrowseResponse {
  string path = 1;
  repeated BrowseNode nodes = 2;
}

message BrowseNode {
  string name = 1;
  NodeType type = 2;
  
  // For NODE_DIRECTORY
  int32 target_count = 10;
  repeated BrowseNode children = 11;  // When recursive
  
  // For NODE_TARGET (when long_format or direct target access)
  Target target = 20;
  
  // For NODE_INFO
  map<string, string> info = 30;
}

enum NodeType {
  NODE_DIRECTORY = 0;
  NODE_TARGET = 1;
  NODE_INFO = 2;
}

// ============================================================================
// Target
// ============================================================================

message Target {
  string id = 1;
  string description = 2;
  repeated string tags = 3;       // Hierarchical paths: "type/network/router"
  bool persistent = 4;
  string protocol = 5;            // "snmp", future: "http", "icmp"
  
  // Polling config
  uint32 interval_ms = 10;
  uint32 buffer_size = 11;
  
  // Runtime state
  string state = 20;              // "polling", "unreachable", "error"
  int64 last_poll_ms = 21;
  string last_error = 22;
  int32 samples_buffered = 23;
  int32 subscribers = 24;
  
  // Statistics
  int64 created_at_ms = 30;
  int64 polls_total = 31;
  int64 polls_success = 32;
  int64 polls_failed = 33;
  int32 avg_poll_ms = 34;
  int32 min_poll_ms = 35;
  int32 max_poll_ms = 36;
  
  // Protocol-specific config
  oneof protocol_config {
    SNMPTargetConfig snmp = 50;
    // Future: HTTPTargetConfig http = 51;
  }
}

// ============================================================================
// SNMP Configuration
// ============================================================================

message SNMPTargetConfig {
  string host = 1;
  uint32 port = 2;
  string oid = 3;
  uint32 timeout_ms = 4;
  uint32 retries = 5;
  
  oneof version {
    SNMPv2cConfig v2c = 10;
    SNMPv3Config v3 = 11;
  }
}

message SNMPv2cConfig {
  string community = 1;
}

message SNMPv3Config {
  string security_name = 1;
  string security_level = 2;    // "noAuthNoPriv", "authNoPriv", "authPriv"
  string auth_protocol = 3;     // "MD5", "SHA", "SHA224", "SHA256", "SHA384", "SHA512"
  string auth_password = 4;
  string priv_protocol = 5;     // "DES", "AES", "AES192", "AES256"
  string priv_password = 6;
  string context_name = 7;
}

// ============================================================================
// Target CRUD
// ============================================================================

message CreateTargetRequest {
  string id = 1;                  // Optional, server generates if empty
  string description = 2;
  repeated string tags = 3;
  bool persistent = 4;
  uint32 interval_ms = 5;
  uint32 buffer_size = 6;
  
  // Protocol-specific config (exactly one must be set)
  oneof protocol {
    SNMPTargetConfig snmp = 20;
    // Future: HTTPTargetConfig http = 21;
  }
}

message CreateTargetResponse {
  bool ok = 1;
  string target_id = 2;
  bool created = 3;               // false = joined existing target
  string message = 4;
}

message UpdateTargetRequest {
  string target_id = 1;
  
  // Fields to update (0/empty = don't change)
  optional string description = 2;
  optional uint32 interval_ms = 3;
  optional uint32 buffer_size = 4;
  optional uint32 timeout_ms = 5;
  optional uint32 retries = 6;
  optional bool persistent = 7;
  
  // Tag operations
  repeated string add_tags = 10;
  repeated string remove_tags = 11;
  repeated string set_tags = 12;  // If non-empty, replaces all tags
}

message UpdateTargetResponse {
  bool ok = 1;
  Target target = 2;
  string message = 3;
}

message DeleteTargetRequest {
  string target_id = 1;
  bool force = 2;                 // Delete even if persistent
}

message DeleteTargetResponse {
  bool ok = 1;
  string message = 2;
}

// ============================================================================
// History
// ============================================================================

message GetHistoryRequest {
  string target_id = 1;
  uint32 last_n = 2;              // Default: 100
}

message GetHistoryResponse {
  string target_id = 1;
  repeated Sample samples = 2;
}

// ============================================================================
// Subscriptions
// ============================================================================

message SubscribeRequest {
  repeated string target_ids = 1;
  repeated string tags = 2;       // Subscribe to all targets matching these tags
}

message SubscribeResponse {
  bool ok = 1;
  repeated string subscribed = 2;
}

message UnsubscribeRequest {
  repeated string target_ids = 1;  // Empty = unsubscribe all
}

message UnsubscribeResponse {
  bool ok = 1;
  repeated string unsubscribed = 2;
}

// ============================================================================
// Config
// ============================================================================

message GetConfigRequest {}

message GetConfigResponse {
  RuntimeConfig config = 1;
}

message SetConfigRequest {
  optional uint32 default_timeout_ms = 1;
  optional uint32 default_retries = 2;
  optional uint32 default_buffer_size = 3;
  optional uint32 min_interval_ms = 4;
}

message SetConfigResponse {
  bool ok = 1;
  RuntimeConfig config = 2;
  string message = 3;
}

message RuntimeConfig {
  // Changeable at runtime
  uint32 default_timeout_ms = 1;
  uint32 default_retries = 2;
  uint32 default_buffer_size = 3;
  uint32 min_interval_ms = 4;
  
  // Read-only (set at startup)
  int32 poller_workers = 10;
  int32 poller_queue_size = 11;
  uint32 reconnect_window_sec = 12;
  
  // Server info
  string version = 20;
  int64 uptime_ms = 21;
  int64 started_at_ms = 22;
}
